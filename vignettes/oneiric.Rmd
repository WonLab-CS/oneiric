---
title: "Simulating Tissues with Oneiric"
author: "Patrick Martin"
output:
    pdf_document: null
    keep_tex: yes
    number_sections: no
    html_document:
        toc: true
package: '`oneiric'''
vignette: |
    %\VignetteIndexEntry{Oneiric User's Guide}
    %\VignetteEncoding{UTF-8}
    %\VignetteEngine{knitr::rmarkdown}
---

#  Introduction

```{r setup, eval = TRUE, echo = TRUE}
library(oneiric)
library(scater)
library(ggplot2)
library(RColorBrewer)
set.seed(288)
```

# Data

## Chaos Parameters
```{r chaos_param, eval = TRUE, echo  = TRUE}

data(oneiric)
map_params
```

## Simulated Territories
```{r sim_ter, eval = TRUE, echo = TRUE}
sim_ter <- paste0(system.file(package = "oneiric"), "/inst/extdata/")
dir(sim_ter)
```

## Preparing output directory

```{r out_dir, eval = TRUE, echo = TRUE}

output <- "/Users/martinp4/Documents/Cedars/Oneiric/simulations/"
```

# Creating New Data sets

## Simulate New Territories 

```{r spatial_sim, eval = TRUE, echo = TRUE}
circle <- simulate_spatial(n_cells = 5000,
    n_territories = 5,
    n_samples = 12,
    pattern = "circle",
    expanse = c(0.1, 0.3))

rod <- simulate_spatial(n_cells = 5000,
    n_territories = 5,
    n_samples = 12,
    pattern = "rod",
    width_range = c(0.0, 0.1),
    length_range = c(0.2, 0.5))

chaos_map <- simulate_spatial(n_cells = 5000,
    n_samples = 12,
    pattern = "chaos",
    expanse = 0.02)

```

### Circular Territories
```{r view_circles, eval = TRUE, echo = TRUE, fig.width = 9, fig.height=9, fig.cap = "Circular Territories"}
circles <- do.call("rbind", circle)
circles$Territory <- as.factor(circles$Territory)
g <- ggplot(circles, aes(x = x, y = y, col = Territory)) +
    geom_point(size = 0.5) +
    theme_bw() +
    scale_color_brewer(palette = "Spectral") +
    facet_wrap(~sample) +
    guides(colour = guide_legend(
        override.aes = list(size =  5)))
print(g)
```

### Rod Territories
```{r view_rod, eval = TRUE, echo = TRUE, fig.width = 9, fig.height=9, fig.cap = "Rod Territories"}
rods <- do.call("rbind", rod)
rods$Territory <- as.factor(rods$Territory)
g <- ggplot(rods, aes(x = x, y = y, col = Territory)) +
    geom_point(size = 0.5) +
    theme_bw() +
    scale_color_brewer(palette = "Spectral") +
    facet_wrap(~sample) +
    guides(colour = guide_legend(
        override.aes = list(size =  5)))
print(g)
```

### Tinkerbell Map Territories
```{r view_chaos, eval = TRUE, echo = TRUE,fig.width = 9, fig.height=9, fig.cap = "Tinkerbell Map Territories"}
chaos <- do.call("rbind", chaos_map)
chaos$Territory <- as.factor(chaos$Territory)
g <- ggplot(chaos, aes(x = x, y = y, col = Territory)) +
    geom_point(size = 0.5) +
    theme_bw() +
    scale_color_brewer(palette = "Spectral") +
    facet_wrap(~sample) +
    guides(colour = guide_legend(
        override.aes = list(size =  5)))
print(g)
```

## Simulating Circle Territories 

```{r circle_solo, eval = TRUE, echo = TRUE}
# Making sure that we have common cell labels
circular <- simulate_spatial(n_cells = 5000,
    n_territories = 5,
    n_samples = 12,
    pattern = "circle",
    expanse = c(0.1, 0.25),
    force_cells = 10)

circular_counts <- simulate_cells(circular,
    cell_composition = 2)

circles <- do.call("rbind", circular_counts$spatial)
circles$Territory <- as.factor(circles$Territory)
g <- ggplot(circles, aes(x = x, y = y, col = Territory)) +
    geom_point(size = 0.5) +
    theme_bw() +
    scale_color_brewer(palette = "Spectral") +
    facet_wrap(~sample) +
    guides(colour = guide_legend(
        override.aes = list(size =  5)))
print(g)

export_simulation(spatial = circular_counts$spatial,
    cells = circular_counts$counts,
    out_dir = output,
    file_tag = "circle_spatial_territories")

```


## Simulating Layered Territories 
### Circle Layers
```{r circle_layer, eval = TRUE, echo = TRUE}
circular_layer <- simulate_spatial(n_cells = 5000,
    n_territories = 1,
    n_samples = 12,
    pattern = "circle",
    expanse = c(0.4, 0.5),
    layer = 5,
    force_cells = 12)

circular_layer_counts <- simulate_cells(circular_layer,
    as_layer = TRUE,
    cell_composition = 2)

# to mimic poor cell type labels 
circular_layer_counts$spatial <- lapply(circular_layer_counts$spatial,
    function(l) {
        locs <- which(l$Territory != 0)
        labs <- sapply(strsplit(l$cell_labels,"_"),"[[",1)
        l$Territory <- labs
        return(l)
    }
)
circles <- do.call("rbind", circular_layer_counts$spatial)
circles$Territory <- as.factor(circles$Territory)
g <- ggplot(circles, aes(x = x, y = y, col = Territory)) +
    geom_point(size = 0.5) +
    theme_bw() +
    scale_color_brewer(palette = "Spectral") +
    facet_wrap(~sample) +
    guides(colour = guide_legend(
        override.aes = list(size =  5)))
print(g)

circles$cell_labels <- as.factor(circles$cell_labels)
g <- ggplot(circles, aes(x = x, y = y, col = cell_labels)) +
    geom_point(size = 0.5) +
    theme_bw() +
    scale_color_brewer(palette = "Spectral") +
    facet_wrap(~sample) +
    guides(colour = guide_legend(
        override.aes = list(size =  5)))
print(g)

export_simulation(spatial = circular_layer_counts$spatial,
    cells = circular_layer_counts$counts,
    out_dir = output,
    file_tag = "layered_spatial_territories")

```
### Chaos Layers
```{r chaos_layer, eval = TRUE, echo = TRUE}
chaos_layer <- simulate_spatial(n_cells = 5000,
    n_samples = 12,
    pattern = "chaos",
    expanse = 0.2,
    layer = 3,
    force_cells = 4)

chaos_layer_counts <- simulate_cells(chaos_layer,
    as_layer = TRUE,
    cell_composition = 2)

chaos_layer_counts$spatial <- lapply(chaos_layer_counts$spatial,
    function(l) {
        locs <- which(l$Territory != 0)
        labs <- sapply(strsplit(l$cell_labels,"_"),"[[",1)
        l$Territory <- labs
        return(l)
    }
)
chaos <- do.call("rbind", chaos_layer_counts$spatial)
chaos$Territory <- as.factor(chaos$Territory)
g <- ggplot(chaos, aes(x = x, y = y, col = Territory)) +
    geom_point(size = 0.5) +
    theme_bw() +
    scale_color_brewer(palette = "Spectral") +
    facet_wrap(~sample) +
    guides(colour = guide_legend(
        override.aes = list(size =  5)))
print(g)


chaos$cell_labels <- as.factor(chaos$cell_labels)
g <- ggplot(chaos, aes(x = x, y = y, col = cell_labels)) +
    geom_point(size = 0.5) +
    theme_bw() +
    scale_color_brewer(palette = "Spectral") +
    facet_wrap(~sample) +
    guides(colour = guide_legend(
        override.aes = list(size =  5)))
print(g)
export_simulation(spatial = chaos_layer_counts$spatial,
    cells = chaos_layer_counts$counts,
    out_dir = output,
    file_tag = "tinker_spatial_territories")

```